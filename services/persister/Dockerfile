FROM node:10.11

# -------------------------------------------------------------------------------------
# Default Environment Variables
# -------------------------------------------------------------------------------------
ENV NODE_ENV production

ENV PER_APP_HOME /opt/persister
ENV PER_USER persister

# -------------------------------------------------------------------------------------
# Setup OS
# -------------------------------------------------------------------------------------
RUN set -x \
  && apt-get update \
  && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------------------------------------------
# Create user
# -------------------------------------------------------------------------------------
RUN mkdir -p ${PER_APP_HOME} \
  && useradd -d "${PER_APP_HOME}" -c "Collector" -s /sbin/nologin "${PER_USER}" \
  && chown --recursive -v ${PER_USER}:${PER_USER} ${PER_APP_HOME}

# -------------------------------------------------------------------------------------
# Set the working directory
# -------------------------------------------------------------------------------------
WORKDIR ${PER_APP_HOME}

# -------------------------------------------------------------------------------------
# Copy the package.json and npm-shrinkwrap.json files and install dependencies
# -------------------------------------------------------------------------------------
COPY package.json npm-shrinkwrap.json ./
RUN npm install

# -------------------------------------------------------------------------------------
# Copy the application files
# -------------------------------------------------------------------------------------
COPY ./bin   ./

# -------------------------------------------------------------------------------------
# Setup application user
# -------------------------------------------------------------------------------------
USER ${PER_USER}

# -------------------------------------------------------------------------------------
# Expose application port number
# -------------------------------------------------------------------------------------
EXPOSE 3000

# -------------------------------------------------------------------------------------
# Launch SCMS Simulator Service
# -------------------------------------------------------------------------------------
CMD ["node", "persister.app.js"]
